CREATE PROCEDURE [ods].[uspODSNG_patient_encounterUpsert]
AS
BEGIN
    SET NOCOUNT ON;
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    DECLARE @DateTime DATETIME = GETDATE();

    -- Update existing records to previous version
    UPDATE [ods].[NG_patient_encounter]
    SET [CurrentRowFlag] = 0,
        [ExpirationDate] = @DateTime,
        [UpdateDate] = @DateTime
    FROM [ods].[NG_patient_encounter] [t]
        INNER JOIN [stage].[NG_patient_encounter] [s]
            ON [t].[enc_id] = [s].[enc_id]
               AND [t].[CurrentRowFlag] = 1;

    SET @DateTime = DATEADD(SS, 1, @DateTime);

    -- Insert New and modified records as current version
    INSERT INTO [ods].[NG_patient_encounter]
    ( [enterprise_id]
      ,[practice_id]
      ,[site_id]
      ,[person_id]
      ,[enc_id]
      ,[enc_timestamp]
      ,[enc_nbr]
      ,[parent_enc_id]
      ,[case_id]
      ,[billable_ind]
      ,[clinical_ind]
      ,[optical_ind]
      ,[location_id]
      ,[locked_by]
      ,[lock_ind]
      ,[billable_timestamp]
      ,[enc_status]
      ,[complaint]
      ,[remarks]
      ,[user_defined1]
      ,[user_defined2]
      ,[user_defined3]
      ,[user_defined4]
      ,[guar_id]
      ,[guar_type]
      ,[cob1_insured_person_id]
      ,[cob1_payer_id]
      ,[auto_accd_loc]
      ,[cond_rel_emp_ind]
      ,[rendering_provider_id]
      ,[admit_provider_id]
      ,[admit_provider_name]
      ,[consult1_provider_id]
      ,[consult1_provider_name]
      ,[consult2_provider_id]
      ,[consult2_provider_name]
      ,[refer_provider_id]
      ,[refer_provider_name]
      ,[refer_location_id]
      ,[patient_type_id]
      ,[onset_date]
      ,[onset_time]
      ,[admit_date]
      ,[discharge_date]
      ,[accident_code]
      ,[final_bill_date]
      ,[last_bill_date]
      ,[pat_resp_date]
      ,[budget_ind]
      ,[bad_debt_prelist_date]
      ,[print_stmt_ind]
      ,[last_statement_date]
      ,[pre_list_ind]
      ,[pre_list_eff_date]
      ,[agency_id]
      ,[send_coll_letter_ind]
      ,[collection_letter_id]
      ,[sim_prompt_ind]
      ,[followup_date]
      ,[followup_ind]
      ,[homebound_ind]
      ,[reinstate_date]
      ,[bill_hold_date]
      ,[type_of_bill]
      ,[supervisor_provider_id]
      ,[checkin_datetime]
      ,[checkout_datetime]
      ,[ub92_enc_ind]
      ,[ub92_linked_enc_id]
      ,[ud_billing_collections1]
      ,[ud_billing_collections2]
      ,[ud_billing_collections3]
      ,[ud_billing_collections4]
      ,[sim_emr_prompt_ind]
      ,[service_auth_excep_cd]
      ,[same_similar_symp_date]
      ,[last_print_statement_date]
      ,[special_program_code]
      ,[bad_debt_status_id]
      ,[cob1_person_payer_id]
      ,[lock_timestamp]
      ,[sliding_fee_action_ind]
      ,[last_seen_date]
      ,[delay_reason_cd]
      ,[epsdt_ref_cond_code]
      ,[sim_ext_prompt_ind]
      ,[old_enc_id]
      ,[height]
      ,[weight]
      ,[bp_systolic]
      ,[bp_diastolic]
      ,[pulse]
      ,[temperature]
      ,[ud_clinical1]
      ,[ud_clinical2]
      ,[ud_clinical3]
      ,[ud_clinical4]
      ,[fqhc_enc_ind]
      ,[facility_location_id]
      ,[created_by]
      ,[create_timestamp]
      ,[modified_by]
      ,[modify_timestamp]
      ,[row_timestamp]
      ,[outsource_exempt_ind]
      ,[epsdt_ref_code]
      ,[prim_er_billing_status]
      ,[sec_er_billing_status]
      ,[group_id]
      ,[group_enc_id]
      ,[incident_to_enc_ind]
      ,[source_product_id]
      ,[family_planning_ind]
      ,[elig_data_check_ind]
      ,[eligibility_id]
      ,[pwk_report_type_cd]
      ,[pwk_report_trans_cd]
      ,[pwk_attach_ctrl_nbr]
      ,[epsdt_enc_code]
      ,[epsdt_enc_code_other]
      ,[fqhc_dirty_ind]
      ,[fqhc_update_date]
      ,[init_treatment_date]
      ,[mrkt_plan_id]
      ,[mrkt_source_id]
      ,[mrkt_comments]
      ,[mrkt_details]
      ,[mrkt_source_type]
      ,[casemgt_case_id]
      ,[ter_er_billing_status]
      ,[ub92_initial_enc_id]
      ,[tax_rate_ind]
      ,[enc_timestamp_tz]
      ,[billable_timestamp_tz]
      ,[checkin_datetime_tz]
      ,[checkout_datetime_tz]
      ,[lock_timestamp_tz]
      ,[create_timestamp_tz]
      ,[modify_timestamp_tz]
      ,[enc_tax_rate_ind]
      ,[uds_homeless_status_id]
      ,[pwk_report_type_cd_2]
      ,[pwk_report_trans_cd_2]
      ,[pwk_attach_ctrl_nbr_2]
      ,[pwk_report_type_cd_3]
      ,[pwk_report_trans_cd_3]
      ,[pwk_attach_ctrl_nbr_3]
      ,[pwk_report_type_cd_4]
      ,[pwk_report_trans_cd_4]
      ,[pwk_attach_ctrl_nbr_4]
      ,[pwk_report_type_cd_5]
      ,[pwk_report_trans_cd_5]
      ,[pwk_attach_ctrl_nbr_5]
      ,[pwk_report_type_cd_6]
      ,[pwk_report_trans_cd_6]
      ,[pwk_attach_ctrl_nbr_6]
      ,[pwk_report_type_cd_7]
      ,[pwk_report_trans_cd_7]
      ,[pwk_attach_ctrl_nbr_7]
      ,[pwk_report_type_cd_8]
      ,[pwk_report_trans_cd_8]
      ,[pwk_attach_ctrl_nbr_8]
      ,[pwk_report_type_cd_9]
      ,[pwk_report_trans_cd_9]
      ,[pwk_attach_ctrl_nbr_9]
      ,[pwk_report_type_cd_10]
      ,[pwk_report_trans_cd_10]
      ,[pwk_attach_ctrl_nbr_10]
      ,[vision_code_category]
      ,[vision_condition_ind_cd]
      ,[vision_code_category_2]
      ,[vision_condition_ind_cd_2]
      ,[vision_code_category_3]
      ,[vision_condition_ind_cd_3]
      ,[not_assigned_prov_elec_ind]
      ,[hearing_vision_rx_date]
      ,[statement_counter]
      ,[prim_enc_rate_sim]
      ,[sec_enc_rate_sim]
      ,[ter_enc_rate_sim]
      ,[prim_enc_rate_amt]
      ,[sec_enc_rate_amt]
      ,[ter_enc_rate_amt]
      ,[pm_ind]
      ,[convert_in_progress_ind]
      ,[rental_ind]
      ,[rental_id]
      ,[enc_changes_service_date]
      ,[enc_changes_location_id]
      ,[enc_changes_payer_id]
      ,[enc_changes_person_payer_id]
      ,[enc_changes_payer_2_id]
      ,[enc_changes_person_payer_2_id]
      ,[enc_changes_payer_3_id]
      ,[enc_changes_person_payer_3_id]
      ,[enc_changes_appr_enc_id]
      ,[recalc_fail_ind]
      ,[claim_codes]
      ,[wc_cond_codes]
      ,[wc_cond_codes_other]
      ,[medical_director_id]
      ,[anes_types_cd]
      ,[anes_phys_status_cd]
      ,[anes_med_dir_cd]
      ,[exempt_enc_concur_ind]
      ,[present_induction_ind]
      ,[zero_bal_ind]
      ,[demonstration_project_id]
      ,[csc_pri_resp_attending]
      ,[csc_sec_resp_attending]
      ,[csc_ter_resp_attending]
      ,[csc_pri_exempt_ind]
      ,[csc_sec_exempt_ind]
      ,[csc_ter_exempt_ind]
      ,[admit_time]
      ,[discharge_time]
      ,[prim_er_narrative]
      ,[sec_er_narrative]
      ,[ter_er_narrative]
      ,[ordering_provider_id]
      ,[ordering_provider_name]
      ,[csc_pri_elig_from_date]
      ,[csc_pri_elig_to_date]
      ,[csc_sec_elig_from_date]
      ,[csc_sec_elig_to_date]
      ,[csc_ter_elig_from_date]
      ,[csc_ter_elig_to_date]
      ,[csc_lib_timespan_id_pri]
      ,[csc_lib_timespan_id_sec]
      ,[csc_lib_timespan_id_ter]
      ,[discharge_status_cd]
      ,[medications_reconciled]
      ,[ccbhc_enc_ind]
      ,[sens_encounter_ind]
      ,[sens_suppress_portal_ind]
      ,[sens_suppress_outreach_ind]
      ,[program_id]
      ,[EffectiveDate]
      ,[ExpirationDate]        
      ,[CurrentRowFlag]
      ,[DeleteRowFlag]
      ,[InsertDate]
    )
    SELECT [enterprise_id]
      ,[practice_id]
      ,[site_id]
      ,[person_id]
      ,[enc_id]
      ,[enc_timestamp]
      ,[enc_nbr]
      ,[parent_enc_id]
      ,[case_id]
      ,[billable_ind]
      ,[clinical_ind]
      ,[optical_ind]
      ,[location_id]
      ,[locked_by]
      ,[lock_ind]
      ,[billable_timestamp]
      ,[enc_status]
      ,[complaint]
      ,[remarks]
      ,[user_defined1]
      ,[user_defined2]
      ,[user_defined3]
      ,[user_defined4]
      ,[guar_id]
      ,[guar_type]
      ,[cob1_insured_person_id]
      ,[cob1_payer_id]
      ,[auto_accd_loc]
      ,[cond_rel_emp_ind]
      ,[rendering_provider_id]
      ,[admit_provider_id]
      ,[admit_provider_name]
      ,[consult1_provider_id]
      ,[consult1_provider_name]
      ,[consult2_provider_id]
      ,[consult2_provider_name]
      ,[refer_provider_id]
      ,[refer_provider_name]
      ,[refer_location_id]
      ,[patient_type_id]
      ,[onset_date]
      ,[onset_time]
      ,[admit_date]
      ,[discharge_date]
      ,[accident_code]
      ,[final_bill_date]
      ,[last_bill_date]
      ,[pat_resp_date]
      ,[budget_ind]
      ,[bad_debt_prelist_date]
      ,[print_stmt_ind]
      ,[last_statement_date]
      ,[pre_list_ind]
      ,[pre_list_eff_date]
      ,[agency_id]
      ,[send_coll_letter_ind]
      ,[collection_letter_id]
      ,[sim_prompt_ind]
      ,[followup_date]
      ,[followup_ind]
      ,[homebound_ind]
      ,[reinstate_date]
      ,[bill_hold_date]
      ,[type_of_bill]
      ,[supervisor_provider_id]
      ,[checkin_datetime]
      ,[checkout_datetime]
      ,[ub92_enc_ind]
      ,[ub92_linked_enc_id]
      ,[ud_billing_collections1]
      ,[ud_billing_collections2]
      ,[ud_billing_collections3]
      ,[ud_billing_collections4]
      ,[sim_emr_prompt_ind]
      ,[service_auth_excep_cd]
      ,[same_similar_symp_date]
      ,[last_print_statement_date]
      ,[special_program_code]
      ,[bad_debt_status_id]
      ,[cob1_person_payer_id]
      ,[lock_timestamp]
      ,[sliding_fee_action_ind]
      ,[last_seen_date]
      ,[delay_reason_cd]
      ,[epsdt_ref_cond_code]
      ,[sim_ext_prompt_ind]
      ,[old_enc_id]
      ,[height]
      ,[weight]
      ,[bp_systolic]
      ,[bp_diastolic]
      ,[pulse]
      ,[temperature]
      ,[ud_clinical1]
      ,[ud_clinical2]
      ,[ud_clinical3]
      ,[ud_clinical4]
      ,[fqhc_enc_ind]
      ,[facility_location_id]
      ,[created_by]
      ,[create_timestamp]
      ,[modified_by]
      ,[modify_timestamp]
      ,[row_timestamp]
      ,[outsource_exempt_ind]
      ,[epsdt_ref_code]
      ,[prim_er_billing_status]
      ,[sec_er_billing_status]
      ,[group_id]
      ,[group_enc_id]
      ,[incident_to_enc_ind]
      ,[source_product_id]
      ,[family_planning_ind]
      ,[elig_data_check_ind]
      ,[eligibility_id]
      ,[pwk_report_type_cd]
      ,[pwk_report_trans_cd]
      ,[pwk_attach_ctrl_nbr]
      ,[epsdt_enc_code]
      ,[epsdt_enc_code_other]
      ,[fqhc_dirty_ind]
      ,[fqhc_update_date]
      ,[init_treatment_date]
      ,[mrkt_plan_id]
      ,[mrkt_source_id]
      ,[mrkt_comments]
      ,[mrkt_details]
      ,[mrkt_source_type]
      ,[casemgt_case_id]
      ,[ter_er_billing_status]
      ,[ub92_initial_enc_id]
      ,[tax_rate_ind]
      ,[enc_timestamp_tz]
      ,[billable_timestamp_tz]
      ,[checkin_datetime_tz]
      ,[checkout_datetime_tz]
      ,[lock_timestamp_tz]
      ,[create_timestamp_tz]
      ,[modify_timestamp_tz]
      ,[enc_tax_rate_ind]
      ,[uds_homeless_status_id]
      ,[pwk_report_type_cd_2]
      ,[pwk_report_trans_cd_2]
      ,[pwk_attach_ctrl_nbr_2]
      ,[pwk_report_type_cd_3]
      ,[pwk_report_trans_cd_3]
      ,[pwk_attach_ctrl_nbr_3]
      ,[pwk_report_type_cd_4]
      ,[pwk_report_trans_cd_4]
      ,[pwk_attach_ctrl_nbr_4]
      ,[pwk_report_type_cd_5]
      ,[pwk_report_trans_cd_5]
      ,[pwk_attach_ctrl_nbr_5]
      ,[pwk_report_type_cd_6]
      ,[pwk_report_trans_cd_6]
      ,[pwk_attach_ctrl_nbr_6]
      ,[pwk_report_type_cd_7]
      ,[pwk_report_trans_cd_7]
      ,[pwk_attach_ctrl_nbr_7]
      ,[pwk_report_type_cd_8]
      ,[pwk_report_trans_cd_8]
      ,[pwk_attach_ctrl_nbr_8]
      ,[pwk_report_type_cd_9]
      ,[pwk_report_trans_cd_9]
      ,[pwk_attach_ctrl_nbr_9]
      ,[pwk_report_type_cd_10]
      ,[pwk_report_trans_cd_10]
      ,[pwk_attach_ctrl_nbr_10]
      ,[vision_code_category]
      ,[vision_condition_ind_cd]
      ,[vision_code_category_2]
      ,[vision_condition_ind_cd_2]
      ,[vision_code_category_3]
      ,[vision_condition_ind_cd_3]
      ,[not_assigned_prov_elec_ind]
      ,[hearing_vision_rx_date]
      ,[statement_counter]
      ,[prim_enc_rate_sim]
      ,[sec_enc_rate_sim]
      ,[ter_enc_rate_sim]
      ,[prim_enc_rate_amt]
      ,[sec_enc_rate_amt]
      ,[ter_enc_rate_amt]
      ,[pm_ind]
      ,[convert_in_progress_ind]
      ,[rental_ind]
      ,[rental_id]
      ,[enc_changes_service_date]
      ,[enc_changes_location_id]
      ,[enc_changes_payer_id]
      ,[enc_changes_person_payer_id]
      ,[enc_changes_payer_2_id]
      ,[enc_changes_person_payer_2_id]
      ,[enc_changes_payer_3_id]
      ,[enc_changes_person_payer_3_id]
      ,[enc_changes_appr_enc_id]
      ,[recalc_fail_ind]
      ,[claim_codes]
      ,[wc_cond_codes]
      ,[wc_cond_codes_other]
      ,[medical_director_id]
      ,[anes_types_cd]
      ,[anes_phys_status_cd]
      ,[anes_med_dir_cd]
      ,[exempt_enc_concur_ind]
      ,[present_induction_ind]
      ,[zero_bal_ind]
      ,[demonstration_project_id]
      ,[csc_pri_resp_attending]
      ,[csc_sec_resp_attending]
      ,[csc_ter_resp_attending]
      ,[csc_pri_exempt_ind]
      ,[csc_sec_exempt_ind]
      ,[csc_ter_exempt_ind]
      ,[admit_time]
      ,[discharge_time]
      ,[prim_er_narrative]
      ,[sec_er_narrative]
      ,[ter_er_narrative]
      ,[ordering_provider_id]
      ,[ordering_provider_name]
      ,[csc_pri_elig_from_date]
      ,[csc_pri_elig_to_date]
      ,[csc_sec_elig_from_date]
      ,[csc_sec_elig_to_date]
      ,[csc_ter_elig_from_date]
      ,[csc_ter_elig_to_date]
      ,[csc_lib_timespan_id_pri]
      ,[csc_lib_timespan_id_sec]
      ,[csc_lib_timespan_id_ter]
      ,[discharge_status_cd]
      ,[medications_reconciled]
      ,[ccbhc_enc_ind]
      ,[sens_encounter_ind]
      ,[sens_suppress_portal_ind]
      ,[sens_suppress_outreach_ind]
      ,[program_id]
      ,@DateTime AS [EffectiveDate]
      ,NULL AS [ExpirationDate]
      ,1 AS [CurrentRowFlag]
      ,0 AS [DeleteRowFlag]
      ,@DateTime AS [InsertDate]
    FROM [stage].[NG_patient_encounter] AS [s]
    WHERE NOT EXISTS
    (
        SELECT *
        FROM [ods].[NG_patient_encounter] AS [t]
        WHERE [t].[enc_id] = [s].[enc_id]
              AND [t].[CurrentRowFlag] = 1
    );  

END;