CREATE PROCEDURE [ods].[uspODSNG_payer_mstrUpsert]
AS
BEGIN
    SET NOCOUNT ON;
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    DECLARE @DateTime DATETIME = GETDATE();

    -- Update existing records to previous version
    UPDATE [ods].[NG_payer_mstr]
    SET [CurrentRowFlag] = 0,
        [ExpirationDate] = @DateTime,
        [UpdateDate] = @DateTime
    FROM [ods].[NG_payer_mstr] [t]
        INNER JOIN [stage].[NG_payer_mstr] [s]
            ON [t].[payer_id] = [s].[payer_id]
               AND [t].[CurrentRowFlag] = 1;

    SET @DateTime = DATEADD(SS, 1, @DateTime);

    -- Insert New and modified records as current version
    INSERT INTO [ods].[NG_payer_mstr]
    (
 [payer_id]
      ,[payer_name]
      ,[plan_name]
      ,[address_line_1]
      ,[address_line_2]
      ,[city]
      ,[state]
      ,[zip]
      ,[country_id]
      ,[county_id]
      ,[claim_type]
      ,[group_nbr]
      ,[group_name]
      ,[payer_nbr]
      ,[notify_ind]
      ,[precert_ind]
      ,[verify_ind]
      ,[contact_last_name]
      ,[contact_first_name]
      ,[contact_middle_name]
      ,[contact_phone]
      ,[contact_ext]
      ,[contact_fax]
      ,[financial_class]
      ,[ins_type]
      ,[plan_nbr]
      ,[sig_source]
      ,[medigap_id_nbr]
      ,[bc_plan_code]
      ,[copay_ind]
      ,[crossover_ind]
      ,[ins_location]
      ,[medipass_ind]
      ,[kenpak_ind]
      ,[payer_id_nbr]
      ,[kenpak_maid]
      ,[refer_auth_req]
      ,[refer_form_format]
      ,[lab_fac_used]
      ,[rad_fac_used]
      ,[diag_code_used]
      ,[dflt_accept_assgn]
      ,[default_deductible]
      ,[plan_type]
      ,[no_edit_ind]
      ,[external_id]
      ,[email_address]
      ,[disp_override_pol_nbr_ind]
      ,[copay_percent_ind]
      ,[claim_sub_type]
      ,[activate_tos_edit_ind]
      ,[max_claim_charges]
      ,[gabetterhealth_ind]
      ,[require_policy_nbr_ind]
      ,[policy_nbr_format_id]
      ,[require_group_nbr_ind]
      ,[group_nbr_format_id]
      ,[policy_nbr_edit_off_ind]
      ,[grp_nbr_edit_off_ind]
      ,[patientfirst_claim_type_ind]
      ,[nyhcra_exempt_ind]
      ,[nonoverride_payer_name_ind]
      ,[health_partners_ind]
      ,[bluechoiceoption_ind]
      ,[disable_super_bill_ind]
      ,[medica_ind]
      ,[provider_sec_ref_qual]
      ,[dental_ind]
      ,[national_plan_id]
      ,[alt_payer_name]
      ,[alt_address_line_1]
      ,[alt_address_line_2]
      ,[alt_city]
      ,[alt_state]
      ,[alt_zip]
      ,[alt_country_id]
      ,[alt_county_id]
      ,[alt_payer_nbr]
      ,[alt_req_both_payments_ind]
      ,[alt_payer_ind]
      ,[alt_payer_id_nbr]
      ,[payer_subgrouping1_id]
      ,[payer_subgrouping2_id]
      ,[payer_web_site]
      ,[payer_alias_name]
      ,[display_ppp_loc_cd_ind]
      ,[pat_ctrl_nbr_digits]
      ,[medicare_a_ind]
      ,[messa_option_ind]
      ,[formulary_provider]
      ,[legacy_copay_tos_1]
      ,[legacy_copay_1]
      ,[legacy_copay_tos_2]
      ,[legacy_copay_2]
      ,[med_payer_group_id]
      ,[alert_msg]
      ,[delete_ind]
      ,[note]
      ,[created_by]
      ,[modified_by]
      ,[create_timestamp]
      ,[modify_timestamp]
      ,[row_timestamp]
      ,[anes_round_cd]
      ,[supp_zero_claims_ind]
      ,[claims_never_bundle_ind]
      ,[disable_diag_break_ind]
      ,[default_resub_code]
      ,[anes_minutes_per_unit]
      ,[ndc_coding_elec_ind]
      ,[pur_svc_elec_ind]
      ,[enable_npi_code]
      ,[group_taxonomy_ind]
      ,[require_case_mgmt_ind]
      ,[pat_pol_nbr_req_ind]
      ,[pcp_2310a_elec_ind]
      ,[tpl_code]
      ,[country_code_ind]
      ,[ext_edit_payer_id_nbr]
      ,[kidmed_ind]
      ,[amt_2300_code]
      ,[cas_2300_code]
      ,[cn1_2300_ind]
      ,[cob_popup_ind]
      ,[pat_resp_amt_ind]
      ,[alt_edit_payer_id_nbr]
      ,[suppress_rendering_code]
      ,[populate_2410CTP_ind]
      ,[cpt_on_revcode_rollup_ind]
      ,[enable_clia_elec_ind]
      ,[def_release_of_info]
      ,[tax_rate_line_item_ind]
      ,[enable_ndc_elec_ind]
      ,[sliding_fee_ins_ind]
      ,[payer_rta_id_nbr]
      ,[suppress_serv_fac_code]
      ,[suppress_ref_prov_ind]
      ,[suppress_2320_amt_b6_ind_old]
      ,[suppress_2320_amt_aae_ind_old]
      ,[suppress_2430_loop_ind]
      ,[claim_cas_ind]
      ,[claim_adj_date_ind]
      ,[enable_2300_CN1_group_ind]
      ,[msp_payer_id_nbr]
      ,[msp_payer_id_ind]
      ,[ndc_claim_break_ind]
      ,[default_rx_nbr_ind]
      ,[elig_ref_support_ind]
      ,[hsno_ind]
      ,[enable_2300_REF_MRN_ind]
      ,[diag_code_num_code]
      ,[elec_sub_ssn_ind]
      ,[elec_pat_as_sub_ind]
      ,[copy_prim_resub_ind]
      ,[elec_dental_diags_ind]
      ,[elec_pur_svc_prov_ind]
      ,[populate_icn_nbr_ind]
      ,[pricing_region_lib_id]
      ,[pop2330_pri_tpl_ind]
      ,[pop2430_pri_tpl_ind]
      ,[elec_default_admit_date_ind]
      ,[elec_rsn_for_visit_ind]
      ,[elec_inst_claim_diags_ind]
      ,[elec_inst_claim_diags_count]
      ,[contracted_payer_ind]
      ,[refund_address_line1]
      ,[refund_address_line2]
      ,[refund_city]
      ,[refund_state]
      ,[refund_zip1]
      ,[refund_country_id]
      ,[refund_county_id]
      ,[tax_exempt_ind]
      ,[include_tax_charges_claims_ind]
      ,[prop_Cas_Claim_ind]
      ,[prevent_COB_billing_ind]
      ,[pop2330_ref_pri_tpl_ind]
      ,[preg_on_837p_ind]
      ,[follows_medicare_rules_ind]
      ,[abn_report_path]
      ,[diag_map_claim_ind]
      ,[claim_diag_map]
      ,[alt_dx_ind]
      ,[populate_AMT_noncovered_ind]
      ,[populate_pat_liability_amt]
      ,[altclmsendauthref]
      ,[payer_exp_date]
      ,[ordering_phys_ind]
      ,[Opt_Mgmt_VSP_Payer_Ind]
      ,[enable_cms_rules]
      ,[apply_cms_rules]
      ,[payment_typology_code]
      ,[practice_ordering_phys_ind]
      ,[payer_medicare_replace_ind]
      ,[main_addr_valid_ind]
      ,[refund_addr_valid_ind]
      ,[EffectiveDate]
      ,[ExpirationDate]        
      ,[CurrentRowFlag]
      ,[DeleteRowFlag]
      ,[InsertDate]
    )
    SELECT [payer_id]
          ,[payer_name]
          ,[plan_name]
          ,[address_line_1]
          ,[address_line_2]
          ,[city]
          ,[state]
          ,[zip]
          ,[country_id]
          ,[county_id]
          ,[claim_type]
          ,[group_nbr]
          ,[group_name]
          ,[payer_nbr]
          ,[notify_ind]
          ,[precert_ind]
          ,[verify_ind]
          ,[contact_last_name]
          ,[contact_first_name]
          ,[contact_middle_name]
          ,[contact_phone]
          ,[contact_ext]
          ,[contact_fax]
          ,[financial_class]
          ,[ins_type]
          ,[plan_nbr]
          ,[sig_source]
          ,[medigap_id_nbr]
          ,[bc_plan_code]
          ,[copay_ind]
          ,[crossover_ind]
          ,[ins_location]
          ,[medipass_ind]
          ,[kenpak_ind]
          ,[payer_id_nbr]
          ,[kenpak_maid]
          ,[refer_auth_req]
          ,[refer_form_format]
          ,[lab_fac_used]
          ,[rad_fac_used]
          ,[diag_code_used]
          ,[dflt_accept_assgn]
          ,[default_deductible]
          ,[plan_type]
          ,[no_edit_ind]
          ,[external_id]
          ,[email_address]
          ,[disp_override_pol_nbr_ind]
          ,[copay_percent_ind]
          ,[claim_sub_type]
          ,[activate_tos_edit_ind]
          ,[max_claim_charges]
          ,[gabetterhealth_ind]
          ,[require_policy_nbr_ind]
          ,[policy_nbr_format_id]
          ,[require_group_nbr_ind]
          ,[group_nbr_format_id]
          ,[policy_nbr_edit_off_ind]
          ,[grp_nbr_edit_off_ind]
          ,[patientfirst_claim_type_ind]
          ,[nyhcra_exempt_ind]
          ,[nonoverride_payer_name_ind]
          ,[health_partners_ind]
          ,[bluechoiceoption_ind]
          ,[disable_super_bill_ind]
          ,[medica_ind]
          ,[provider_sec_ref_qual]
          ,[dental_ind]
          ,[national_plan_id]
          ,[alt_payer_name]
          ,[alt_address_line_1]
          ,[alt_address_line_2]
          ,[alt_city]
          ,[alt_state]
          ,[alt_zip]
          ,[alt_country_id]
          ,[alt_county_id]
          ,[alt_payer_nbr]
          ,[alt_req_both_payments_ind]
          ,[alt_payer_ind]
          ,[alt_payer_id_nbr]
          ,[payer_subgrouping1_id]
          ,[payer_subgrouping2_id]
          ,[payer_web_site]
          ,[payer_alias_name]
          ,[display_ppp_loc_cd_ind]
          ,[pat_ctrl_nbr_digits]
          ,[medicare_a_ind]
          ,[messa_option_ind]
          ,[formulary_provider]
          ,[legacy_copay_tos_1]
          ,[legacy_copay_1]
          ,[legacy_copay_tos_2]
          ,[legacy_copay_2]
          ,[med_payer_group_id]
          ,[alert_msg]
          ,[delete_ind]
          ,[note]
          ,[created_by]
          ,[modified_by]
          ,[create_timestamp]
          ,[modify_timestamp]
          ,[row_timestamp]
          ,[anes_round_cd]
          ,[supp_zero_claims_ind]
          ,[claims_never_bundle_ind]
          ,[disable_diag_break_ind]
          ,[default_resub_code]
          ,[anes_minutes_per_unit]
          ,[ndc_coding_elec_ind]
          ,[pur_svc_elec_ind]
          ,[enable_npi_code]
          ,[group_taxonomy_ind]
          ,[require_case_mgmt_ind]
          ,[pat_pol_nbr_req_ind]
          ,[pcp_2310a_elec_ind]
          ,[tpl_code]
          ,[country_code_ind]
          ,[ext_edit_payer_id_nbr]
          ,[kidmed_ind]
          ,[amt_2300_code]
          ,[cas_2300_code]
          ,[cn1_2300_ind]
          ,[cob_popup_ind]
          ,[pat_resp_amt_ind]
          ,[alt_edit_payer_id_nbr]
          ,[suppress_rendering_code]
          ,[populate_2410CTP_ind]
          ,[cpt_on_revcode_rollup_ind]
          ,[enable_clia_elec_ind]
          ,[def_release_of_info]
          ,[tax_rate_line_item_ind]
          ,[enable_ndc_elec_ind]
          ,[sliding_fee_ins_ind]
          ,[payer_rta_id_nbr]
          ,[suppress_serv_fac_code]
          ,[suppress_ref_prov_ind]
          ,[suppress_2320_amt_b6_ind_old]
          ,[suppress_2320_amt_aae_ind_old]
          ,[suppress_2430_loop_ind]
          ,[claim_cas_ind]
          ,[claim_adj_date_ind]
          ,[enable_2300_CN1_group_ind]
          ,[msp_payer_id_nbr]
          ,[msp_payer_id_ind]
          ,[ndc_claim_break_ind]
          ,[default_rx_nbr_ind]
          ,[elig_ref_support_ind]
          ,[hsno_ind]
          ,[enable_2300_REF_MRN_ind]
          ,[diag_code_num_code]
          ,[elec_sub_ssn_ind]
          ,[elec_pat_as_sub_ind]
          ,[copy_prim_resub_ind]
          ,[elec_dental_diags_ind]
          ,[elec_pur_svc_prov_ind]
          ,[populate_icn_nbr_ind]
          ,[pricing_region_lib_id]
          ,[pop2330_pri_tpl_ind]
          ,[pop2430_pri_tpl_ind]
          ,[elec_default_admit_date_ind]
          ,[elec_rsn_for_visit_ind]
          ,[elec_inst_claim_diags_ind]
          ,[elec_inst_claim_diags_count]
          ,[contracted_payer_ind]
          ,[refund_address_line1]
          ,[refund_address_line2]
          ,[refund_city]
          ,[refund_state]
          ,[refund_zip1]
          ,[refund_country_id]
          ,[refund_county_id]
          ,[tax_exempt_ind]
          ,[include_tax_charges_claims_ind]
          ,[prop_Cas_Claim_ind]
          ,[prevent_COB_billing_ind]
          ,[pop2330_ref_pri_tpl_ind]
          ,[preg_on_837p_ind]
          ,[follows_medicare_rules_ind]
          ,[abn_report_path]
          ,[diag_map_claim_ind]
          ,[claim_diag_map]
          ,[alt_dx_ind]
          ,[populate_AMT_noncovered_ind]
          ,[populate_pat_liability_amt]
          ,[altclmsendauthref]
          ,[payer_exp_date]
          ,[ordering_phys_ind]
          ,[Opt_Mgmt_VSP_Payer_Ind]
          ,[enable_cms_rules]
          ,[apply_cms_rules]
          ,[payment_typology_code]
          ,[practice_ordering_phys_ind]
          ,[payer_medicare_replace_ind]
          ,[main_addr_valid_ind]
          ,[refund_addr_valid_ind]
          ,@DateTime AS [EffectiveDate]
          ,NULL AS [ExpirationDate]
          ,1 AS [CurrentRowFlag]
          ,0 AS [DeleteRowFlag]
          ,@DateTime AS [InsertDate]
    FROM [stage].[NG_payer_mstr] AS [s]
    WHERE NOT EXISTS
    (
        SELECT *
        FROM [ods].[NG_payer_mstr] AS [t]
        WHERE [t].[payer_id] = [s].[payer_id]
              AND [t].[CurrentRowFlag] = 1
    );  

END;