CREATE PROCEDURE [ods].[uspODSCPR_INSCOMPUpsert]
AS
BEGIN
    SET NOCOUNT ON;
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    DECLARE @DateTime DATETIME = GETDATE();

    -- Update existing records to previous version
    UPDATE [ods].[CPR_INSCOMP]
    SET [CurrentRowFlag] = 0,
        [ExpirationDate] = @DateTime,
        [UpdateDate] = @DateTime
    FROM [ods].[CPR_INSCOMP] [t]
        INNER JOIN [stage].[CPR_INSCOMP] [s]
            ON [t].[NO] = [s].[NO]
               AND [t].[CurrentRowFlag] = 1;

    SET @DateTime = DATEADD(SS, 1, @DateTime);

    -- Insert New and modified records as current version
    INSERT INTO [ods].[CPR_INSCOMP]
    ([NO]
      ,[CONTACT]
      ,[ORG]
      ,[ID]
      ,[PAYOR]
      ,[ADDRESS]
      ,[ADDR2]
      ,[PHONE]
      ,[FAX]
      ,[CITY]
      ,[ST]
      ,[ZIP]
      ,[SBCONTACT]
      ,[SBORG]
      ,[SBADDRESS]
      ,[SBCITY]
      ,[SBST]
      ,[SBZIP]
      ,[PROVIDER]
      ,[NEICPID]
      ,[NETID]
      ,[NEEDFAAT]
      ,[NEEDNDC]
      ,[PHARMNO]
      ,[PCN]
      ,[BINNO]
      ,[NCPDPVER]
      ,[MDFIELD]
      ,[DEFCMPDCD]
      ,[DEFPAMC]
      ,[PTINFO]
      ,[EMPINFO]
      ,[INVOICETYP]
      ,[TEXTTYPE]
      ,[HCPCUNITS]
      ,[YEAR4DIG]
      ,[DOLLARSYM]
      ,[PGTOT]
      ,[SHOPAY2ND]
      ,[NOTES]
      ,[MATRIXYN]
      ,[COLUMNK]
      ,[ICD9TEXT]
      ,[MRNORPID]
      ,[SOCDATE]
      ,[USETYPE]
      ,[PLSERV]
      ,[ENVOYSPLIT]
      ,[REQAUTH]
      ,[DEFDFEE]
      ,[BILLMETH]
      ,[KILLDOT]
      ,[SITENO]
      ,[UPDTSP]
      ,[UPDTEP]
      ,[NEVSTAT]
      ,[INACTIVE]
      ,[ADDR30_1]
      ,[NEEDEAAT]
      ,[ALLOWEDS]
      ,[SPECIAL]
      ,[UBSPECCODE]
      ,[DOCIDNUM]
      ,[HCFA2LIN]
      ,[EIN]
      ,[TXTIMAGE]
      ,[WRAP24D]
      ,[GROUP33]
      ,[RENDERID]
      ,[NURSETIME]
      ,[CONTRACT]
      ,[CONTRACTNO]
      ,[CLMINQUIRY]
      ,[DRUGMETH]
      ,[CLEARTYPE]
      ,[PDTYPE]
      ,[CERTID]
      ,[DEFCOLLECT]
      ,[COPYNDC]
      ,[CALCGROSS]
      ,[SPIDQUAL]
      ,[OVERALL]
      ,[GROUP_]
      ,[TXPST]
      ,[PIDQUAL]
      ,[PCPIDQUAL]
      ,[CALCING]
      ,[RENDPROVID]
      ,[PROVIDTYPE]
      ,[TAXONOMY]
      ,[SECONDID]
      ,[SECIDTYPE]
      ,[SENDZEROS]
      ,[DEFPOPSID]
      ,[DEFIVPSID]
      ,[SUMCOST]
      ,[INDTYPE]
      ,[SUMINGR]
      ,[NOCMPD]
      ,[UNIQUERX]
      ,[PROIDQUAL]
      ,[USEEMPLPCN]
      ,[DELFLAG]
      ,[TOUCHDATE]
      ,[CHGBYHOST]
      ,[CREATEDON]
      ,[CREATEDBY]
      ,[NOHCFAINV]
      ,[INDTYP]
      ,[ORDPROVTYP]
      ,[REFERINGMD]
      ,[BILLPROVID]
      ,[BLPROVTYP]
      ,[IMPORTDIAG]
      ,[NOSSN]
      ,[NAICNO]
      ,[EBILLGOOD]
      ,[USEDAILYPRICE]
      ,[USEMCRMODS]
      ,[CREATEFOLLOWUP]
      ,[HCPCBASEDSP]
      ,[RRMCR]
      ,[AUTOSPLITDT]
      ,[CONVKEY]
      ,[SERVICECODE]
      ,[AUTHREQUIREMENT]
      ,[COLLECTOR]
      ,[SPAN2M]
      ,[COLLAPSEIT]
      ,[DEFCUSTLOC]
      ,[USECONTRACTINFO]
      ,[USENDC]
      ,[USENARRDESC]
      ,[BOX33BQUALIFIER]
      ,[USE24J]
      ,[BOX24IQUALIFIER]
      ,[CMNREQUIRED]
      ,[UPDATEALLSP]
      ,[UPDATEALLEP]
      ,[BILLASINDIVIDUAL]
      ,[PAYEEID]
      ,[PULLB1FROMCLIENT]
      ,[USEGRTNPI]
      ,[USEDOCNPI]
      ,[USENDCUNITS]
      ,[SENDNDCUNITQUAL]
      ,[OCNA]
      ,[CLAIMOFFICEID]
      ,[REVGROUP]
      ,[REVCARDHOLDER]
      ,[SEND2010BBN]
      ,[DEFRXORIGIN]
      ,[AUTOPOPEV]
      ,[DEFPATYPE]
      ,[TIMELYFILING]
      ,[USENDCQUAL]
      ,[PERCENTCOV]
      ,[SUPPLEMENTARY]
      ,[SENDAMTON2ND]
      ,[SENDPLANID]
      ,[MATRIXTYPE]
      ,[MCRSPECMULT]
      ,[MCREXPMULT]
      ,[MCRMATRIXST]
      ,[EOBINDICATOR]
      ,[EXPORTCHARGES]
      ,[EXPORTADJCODE]
      ,[PAYER340B]
      ,[EXCLUDEREFG5]
      ,[EXCLUDEREFFY]
      ,[USEMCALFORMATTING]
      ,[MCALSENDMODIFIER]
      ,[MCALSENDUPN]
      ,[COMBINEDEL]
      ,[SPANRECRENT]
      ,[NODECICD9]
      ,[MEDICALITEMIZED]
      ,[PROFITMARGIN]
      ,[SENDSTARTONLY]
      ,[INITIALCLAIM]
      ,[BILLARREARS]
      ,[TYPECODE]
      ,[ORGSIGNATURE]
      ,[AUTOTRANSFER]
      ,[TRANSFERTHRESHOLD]
      ,[TRANSFERADJCODE]
      ,[SEND2010AAPER]
      ,[SENDEMPLOYER2010BA]
      ,[SEND2300K3]
      ,[REMOVEDASHCLM01]
      ,[MULTIUSENOTBILLABLE]
      ,[AUTOMOVESPRX]
      ,[OTHERCOVCODE]
      ,[COBSENDCOPAY]
      ,[ADDCHARGE]
      ,[REMOVED9DU]
      ,[USEUNITPRICE]
      ,[CHECKCO35]
      ,[DUSECONDARY]
      ,[D9SECONDARY]
      ,[DEFBOX32]
      ,[AUTOSPLITPERDIEMS]
      ,[BILLPROVIDFROMCLIENT]
      ,[E9SENDPHARMACIST]
      ,[NPI]
      ,[ALLUPPERCASE]
      ,[CFK_ADJCODES_LIFEMAX]
      ,[BLANKPERSONCODE]
      ,[SENDDUFORDQ]
      ,[SENDEMAILINHN]
      ,[SERVICETYPE]
      ,[SENDF5INDX]
      ,[CREATEREJECTIONCOB]
      ,[CBAPAYOR]
      ,[DOCNONBILL]
      ,[SENDREFEA]
      ,[FORCE4010]
      ,[SPLITBYAUTH]
      ,[ENABLEBENEFIT]
      ,[CLAIMBYCALENDARMONTH]
      ,[REPORTTYPE]
      ,[TRANSCODE]
      ,[ASSESSTAX]
      ,[TAX_FIXEDRATE]
      ,[ASSESSTAX_RENTALS]
      ,[CFK_CENTRAL_CONTACT]
      ,[SENDPRESCRIBERFIRSTNAME]
      ,[SENDNP]
      ,[DEFAULTPRCOBENTRY]
      ,[EXCLUDE2420EPHYSICIAN]
      ,[DEFAULTPLACERESIDENCE]
      ,[POPPRIMARYPAIDAMOUNTDISABLED]
      ,[SENDHPID2010BB]
      ,[SENDPIDREF]
      ,[HPID]
      ,[SECONDARYPLANTYPE]
      ,[ALWAYSBILLASDENIAL]
      ,[FORCEICD9]
      ,[CMS1500_ICD10_BOX30]
      ,[CMS1500_PRINTBOX17QUAL]
      ,[CMS1500_USE_OLD_1500]
      ,[CMS1500_BOX17AQUAL]
      ,[CMS1500_PRINTDECIMAL_DIAGCODE]
      ,[CFK_PERDIEMTEMPLATEHEADER]
      ,[SENDUNITOFMEASURE]
      ,[IGNOREMISSINGDIAGNOSIS]
      ,[CLAIMSUBMISSIONFEEADJCODE]
      ,[CLAIMSUBMISSIONFEEQUALIFIER]
      ,[defaultsalestaxbasis]
      ,[billdiscardquantity]
      ,[authbydosefrequency]
      ,[alwaysautotransfer]
      ,[couponinforequired]
      ,[EffectiveDate]
      ,[ExpirationDate]
      ,[CurrentRowFlag]
      ,[DeleteRowFlag]
      ,[InsertDate]
    )
    SELECT [NO]
          ,[CONTACT]
          ,[ORG]
          ,[ID]
          ,[PAYOR]
          ,[ADDRESS]
          ,[ADDR2]
          ,[PHONE]
          ,[FAX]
          ,[CITY]
          ,[ST]
          ,[ZIP]
          ,[SBCONTACT]
          ,[SBORG]
          ,[SBADDRESS]
          ,[SBCITY]
          ,[SBST]
          ,[SBZIP]
          ,[PROVIDER]
          ,[NEICPID]
          ,[NETID]
          ,[NEEDFAAT]
          ,[NEEDNDC]
          ,[PHARMNO]
          ,[PCN]
          ,[BINNO]
          ,[NCPDPVER]
          ,[MDFIELD]
          ,[DEFCMPDCD]
          ,[DEFPAMC]
          ,[PTINFO]
          ,[EMPINFO]
          ,[INVOICETYP]
          ,[TEXTTYPE]
          ,[HCPCUNITS]
          ,[YEAR4DIG]
          ,[DOLLARSYM]
          ,[PGTOT]
          ,[SHOPAY2ND]
          ,[NOTES]
          ,[MATRIXYN]
          ,[COLUMNK]
          ,[ICD9TEXT]
          ,[MRNORPID]
          ,[SOCDATE]
          ,[USETYPE]
          ,[PLSERV]
          ,[ENVOYSPLIT]
          ,[REQAUTH]
          ,[DEFDFEE]
          ,[BILLMETH]
          ,[KILLDOT]
          ,[SITENO]
          ,[UPDTSP]
          ,[UPDTEP]
          ,[NEVSTAT]
          ,[INACTIVE]
          ,[ADDR30_1]
          ,[NEEDEAAT]
          ,[ALLOWEDS]
          ,[SPECIAL]
          ,[UBSPECCODE]
          ,[DOCIDNUM]
          ,[HCFA2LIN]
          ,[EIN]
          ,[TXTIMAGE]
          ,[WRAP24D]
          ,[GROUP33]
          ,[RENDERID]
          ,[NURSETIME]
          ,[CONTRACT]
          ,[CONTRACTNO]
          ,[CLMINQUIRY]
          ,[DRUGMETH]
          ,[CLEARTYPE]
          ,[PDTYPE]
          ,[CERTID]
          ,[DEFCOLLECT]
          ,[COPYNDC]
          ,[CALCGROSS]
          ,[SPIDQUAL]
          ,[OVERALL]
          ,[GROUP_]
          ,[TXPST]
          ,[PIDQUAL]
          ,[PCPIDQUAL]
          ,[CALCING]
          ,[RENDPROVID]
          ,[PROVIDTYPE]
          ,[TAXONOMY]
          ,[SECONDID]
          ,[SECIDTYPE]
          ,[SENDZEROS]
          ,[DEFPOPSID]
          ,[DEFIVPSID]
          ,[SUMCOST]
          ,[INDTYPE]
          ,[SUMINGR]
          ,[NOCMPD]
          ,[UNIQUERX]
          ,[PROIDQUAL]
          ,[USEEMPLPCN]
          ,[DELFLAG]
          ,[TOUCHDATE]
          ,[CHGBYHOST]
          ,[CREATEDON]
          ,[CREATEDBY]
          ,[NOHCFAINV]
          ,[INDTYP]
          ,[ORDPROVTYP]
          ,[REFERINGMD]
          ,[BILLPROVID]
          ,[BLPROVTYP]
          ,[IMPORTDIAG]
          ,[NOSSN]
          ,[NAICNO]
          ,[EBILLGOOD]
          ,[USEDAILYPRICE]
          ,[USEMCRMODS]
          ,[CREATEFOLLOWUP]
          ,[HCPCBASEDSP]
          ,[RRMCR]
          ,[AUTOSPLITDT]
          ,[CONVKEY]
          ,[SERVICECODE]
          ,[AUTHREQUIREMENT]
          ,[COLLECTOR]
          ,[SPAN2M]
          ,[COLLAPSEIT]
          ,[DEFCUSTLOC]
          ,[USECONTRACTINFO]
          ,[USENDC]
          ,[USENARRDESC]
          ,[BOX33BQUALIFIER]
          ,[USE24J]
          ,[BOX24IQUALIFIER]
          ,[CMNREQUIRED]
          ,[UPDATEALLSP]
          ,[UPDATEALLEP]
          ,[BILLASINDIVIDUAL]
          ,[PAYEEID]
          ,[PULLB1FROMCLIENT]
          ,[USEGRTNPI]
          ,[USEDOCNPI]
          ,[USENDCUNITS]
          ,[SENDNDCUNITQUAL]
          ,[OCNA]
          ,[CLAIMOFFICEID]
          ,[REVGROUP]
          ,[REVCARDHOLDER]
          ,[SEND2010BBN]
          ,[DEFRXORIGIN]
          ,[AUTOPOPEV]
          ,[DEFPATYPE]
          ,[TIMELYFILING]
          ,[USENDCQUAL]
          ,[PERCENTCOV]
          ,[SUPPLEMENTARY]
          ,[SENDAMTON2ND]
          ,[SENDPLANID]
          ,[MATRIXTYPE]
          ,[MCRSPECMULT]
          ,[MCREXPMULT]
          ,[MCRMATRIXST]
          ,[EOBINDICATOR]
          ,[EXPORTCHARGES]
          ,[EXPORTADJCODE]
          ,[PAYER340B]
          ,[EXCLUDEREFG5]
          ,[EXCLUDEREFFY]
          ,[USEMCALFORMATTING]
          ,[MCALSENDMODIFIER]
          ,[MCALSENDUPN]
          ,[COMBINEDEL]
          ,[SPANRECRENT]
          ,[NODECICD9]
          ,[MEDICALITEMIZED]
          ,[PROFITMARGIN]
          ,[SENDSTARTONLY]
          ,[INITIALCLAIM]
          ,[BILLARREARS]
          ,[TYPECODE]
          ,[ORGSIGNATURE]
          ,[AUTOTRANSFER]
          ,[TRANSFERTHRESHOLD]
          ,[TRANSFERADJCODE]
          ,[SEND2010AAPER]
          ,[SENDEMPLOYER2010BA]
          ,[SEND2300K3]
          ,[REMOVEDASHCLM01]
          ,[MULTIUSENOTBILLABLE]
          ,[AUTOMOVESPRX]
          ,[OTHERCOVCODE]
          ,[COBSENDCOPAY]
          ,[ADDCHARGE]
          ,[REMOVED9DU]
          ,[USEUNITPRICE]
          ,[CHECKCO35]
          ,[DUSECONDARY]
          ,[D9SECONDARY]
          ,[DEFBOX32]
          ,[AUTOSPLITPERDIEMS]
          ,[BILLPROVIDFROMCLIENT]
          ,[E9SENDPHARMACIST]
          ,[NPI]
          ,[ALLUPPERCASE]
          ,[CFK_ADJCODES_LIFEMAX]
          ,[BLANKPERSONCODE]
          ,[SENDDUFORDQ]
          ,[SENDEMAILINHN]
          ,[SERVICETYPE]
          ,[SENDF5INDX]
          ,[CREATEREJECTIONCOB]
          ,[CBAPAYOR]
          ,[DOCNONBILL]
          ,[SENDREFEA]
          ,[FORCE4010]
          ,[SPLITBYAUTH]
          ,[ENABLEBENEFIT]
          ,[CLAIMBYCALENDARMONTH]
          ,[REPORTTYPE]
          ,[TRANSCODE]
          ,[ASSESSTAX]
          ,[TAX_FIXEDRATE]
          ,[ASSESSTAX_RENTALS]
          ,[CFK_CENTRAL_CONTACT]
          ,[SENDPRESCRIBERFIRSTNAME]
          ,[SENDNP]
          ,[DEFAULTPRCOBENTRY]
          ,[EXCLUDE2420EPHYSICIAN]
          ,[DEFAULTPLACERESIDENCE]
          ,[POPPRIMARYPAIDAMOUNTDISABLED]
          ,[SENDHPID2010BB]
          ,[SENDPIDREF]
          ,[HPID]
          ,[SECONDARYPLANTYPE]
          ,[ALWAYSBILLASDENIAL]
          ,[FORCEICD9]
          ,[CMS1500_ICD10_BOX30]
          ,[CMS1500_PRINTBOX17QUAL]
          ,[CMS1500_USE_OLD_1500]
          ,[CMS1500_BOX17AQUAL]
          ,[CMS1500_PRINTDECIMAL_DIAGCODE]
          ,[CFK_PERDIEMTEMPLATEHEADER]
          ,[SENDUNITOFMEASURE]
          ,[IGNOREMISSINGDIAGNOSIS]
          ,[CLAIMSUBMISSIONFEEADJCODE]
          ,[CLAIMSUBMISSIONFEEQUALIFIER]
          ,[defaultsalestaxbasis]
          ,[billdiscardquantity]
          ,[authbydosefrequency]
          ,[alwaysautotransfer]
          ,[couponinforequired]
          ,@DateTime AS [EffectiveDate]
          ,NULL AS [ExpirationDate]
          ,1 AS [CurrentRowFlag]
          ,0 AS [DeleteRowFlag]
          ,@DateTime AS [InsertDate]
    FROM [stage].[CPR_INSCOMP] AS [s]
    WHERE NOT EXISTS
    (
        SELECT *
        FROM [ods].[CPR_INSCOMP] AS [t]
        WHERE [t].[NO] = [s].[NO]
              AND [t].[CurrentRowFlag] = 1
    );

END;