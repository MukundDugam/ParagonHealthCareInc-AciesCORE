CREATE PROCEDURE [ods].[uspODSCPR_HRUpsert]
AS
BEGIN
    SET NOCOUNT ON;
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    DECLARE @DateTime DATETIME = GETDATE();

    -- Update existing records to previous version
    UPDATE [ods].[CPR_HR]
    SET [CurrentRowFlag] = 0,
        [ExpirationDate] = @DateTime,
        [UpdateDate] = @DateTime
    FROM [ods].[CPR_HR] [t]
        INNER JOIN [stage].[CPR_HR] [s]
            ON [t].[MRN] = [s].[MRN]
               AND [t].[CurrentRowFlag] = 1;

    SET @DateTime = DATEADD(SS, 1, @DateTime);

    -- Insert New and modified records as current version
    INSERT INTO [ods].[CPR_HR]
    (
  		[MRN] ,
		[FIRST_NAME],
		[LAST_NAME],
		[ADDRESS],
		[CITY],
		[STATE],
		[ZIP],
		[ADDRESS2],
		[CITY2],
		[STATE2],
		[ZIP2],
		[PHONE],
		[COUNTY],
		[DOB],
		[SSN],
		[SEX],
		[LANGUAGE],
		[PHYSICIAN],
		[PH_SPEC],
		[PH_ADDRESS],
		[PH_ADDRES2],
		[PH_CITY],
		[PH_STATE],
		[PH_ZIP],
		[PH_PHONE],
		[PH_PHONEXT],
		[PH_FAX],
		[PH_UPIN],
		[PH_MCD],
		[PH_DEA],
		[PH_LIC],
		[PH_LAST],
		[PH_FIRST],
		[PH_NO],
		[PHYSICIAN2],
		[PH_SPEC2],
		[PH_ADDR2],
		[PH_ADDR22],
		[PH_CITY2],
		[PH_STATE2],
		[PH_PHONE2],
		[PH_PHONEX2],
		[PH_FAX2],
		[PH_ZIP2],
		[PH_UPIN2],
		[PH_MCD2],
		[PH_DEA2],
		[PH_LIC2],
		[PH_LAST2],
		[PH_FIRST2],
		[PH_NO2],
		[ROUTE],
		[MED_HIST],
		[DELIVINS],
		[PUMP],
		[PUMPTYPE],
		[PUMP_SSN],
		[ACCESS],
		[PLACED],
		[WHOPLACED],
		[PUMPPARAMS],
		[ORDERS],
		[LABORDERS],
		[DIET],
		[ACTLEVEL],
		[HOSPITAL],
		[HOSP_ROOM],
		[ADM_DATE],
		[REF_DATE],
		[HEIGHT],
		[WEIGHT],
		[ALLERGIES],
		[CULTSENS],
		[SOC],
		[CODESTAT],
		[ADVDIRECT],
		[DISC_DATE],
		[DIAGNOSIS1],
		[DIAGNOSIS2],
		[DIAGNOSIS3],
		[ADD_DIAG],
		[ICD91],
		[ICD92],
		[ICD93],
		[ICD94],
		[SURGERY1],
		[SURGDATE1],
		[SURGERY2],
		[SURGDATE2],
		[DIABETIC],
		[REFERRAL],
		[SALESREP],
		[SALESCODE],
		[NURSE_AGEN],
		[NURSE_CONT],
		[NURSE_PHON],
		[NURSE_FAX],
		[NURSE_ADDR],
		[NURSE_CITY],
		[NURSE_ST],
		[NURSE_ZIP],
		[PRIMARY_RN],
		[CM],
		[CONTACT],
		[CONT_PHONE],
		[CONT_REL],
		[PCG],
		[PCG_PHONE],
		[PCG_REL],
		[SERVAREA],
		[MARITAL],
		[ACCIDENT],
		[PHARMACY],
		[PHARMPHONE],
		[PHARM1],
		[PHARM2],
		[PHARM3],
		[DIRECTIONS],
		[PAT_TYPE],
		[PAT_STAT],
		[ONHOLDSTAR],
		[ONHOLDSTOP],
		[BP],
		[HR],
		[RR],
		[TEMP],
		[P_DLSEEN],
		[PCPLASTREV],
		[BALANCE],
		[LASTBILLED],
		[LASTPAYREC],
		[BILL_STAT],
		[STATORDER],
		[NUMTODO],
		[USERDEF1],
		[USERDEF2],
		[USERDEF3],
		[USERDEF4],
		[USERDEF5],
		[USERDEF6],
		[USERDEF7],
		[NOCATH],
		[LICNUM],
		[SITENO],
		[ALERT_B],
		[ALERT_C],
		[PAT_CAT],
		[USEHHLA],
		[SENTHHLA],
		[HEIGHTCM],
		[WEIGHTKG],
		[BSA],
		[LBW],
		[LBWKG],
		[IBW],
		[IBWKG],
		[OTHALLERGY],
		[SHOWDCD],
		[WT],
		[NREV_PCP],
		[NREV_MDCP],
		[NREV_NCP],
		[PFUNC],
		[PTO],
		[MAX_FAX_NO],
		[DEFCOLLECT],
		[DEMOCOMPL],
		[PHONEEVE],
		[PH_CONT],
		[PH_CONT2],
		[WEIGHTDATE],
		[INUSE],
		[LASTFAX],
		[UPDATED],
		[DELFLAG],
		[TOUCHDATE],
		[CHGBYHOST],
		[CREATEDON],
		[CREATEDBY],
		[RELPROTINFO],
		[WORKPHONE],
		[CELLPHONE],
		[AGENCYFK],
		[SALESFK],
		[SHP_INCLUDEINOUTCOMES],
		[SHP_SITEOFSERVICE],
		[SHP_SITEOFSERVICEOTHER],
		[SHP_ACUITYADMISSION],
		[SHP_CATHETERTRACKING],
		[PCG_PHONE2],
		[CONT_PHONE2],
		[SHP_WEIGHTADMITNUMBER],
		[MAILNAME],
		[SHP_STATUS],
		[PH_ORG],
		[PH_ORG2],
		[MCDNUM],
		[CONVKEY],
		[COLLECTOR],
		[CPK_HR],
		[EMAIL],
		[CFK_PNNAMES_RESPONSIBLE],
		[CFK_REFSOURC],
		[CFK_POPUPDATA_ENTTEAMS],
		[PSEXCLUDE],
		[PSMESSAGE],
		[WEBACCESS],
		[CBA],
		[LOCKED],
		[SENDDTEMAIL],
		[LICENSEISSUER],
		[LICENSEQUALIFIER],
		[CFK_TAXCODES],
		[PAT_BAL],
		[PSSEPARATE],
		[CFK_INSCOMP_CONTRACT],
		[ASSISTMED],
		[MSDUPLOAD],
		[ISTHERIGYPATIENT],
		[isalertbpopulated],
		[isalertcpopulated],
		[latitude],
		[longitude],
		[primaryph],
		[licstate],
		[labelalert],
		[poinjrxalerts],
		[healthcaredatainteroppatientkey],
        [EffectiveDate],
        [ExpirationDate],
        [CurrentRowFlag],
        [DeleteRowFlag],
        [InsertDate]
    )
    SELECT
		[MRN] ,
			[FIRST_NAME],
			[LAST_NAME],
			[ADDRESS],
			[CITY],
			[STATE],
			[ZIP],
			[ADDRESS2],
			[CITY2],
			[STATE2],
			[ZIP2],
			[PHONE],
			[COUNTY],
			[DOB],
			[SSN],
			[SEX],
			[LANGUAGE],
			[PHYSICIAN],
			[PH_SPEC],
			[PH_ADDRESS],
			[PH_ADDRES2],
			[PH_CITY],
			[PH_STATE],
			[PH_ZIP],
			[PH_PHONE],
			[PH_PHONEXT],
			[PH_FAX],
			[PH_UPIN],
			[PH_MCD],
			[PH_DEA],
			[PH_LIC],
			[PH_LAST],
			[PH_FIRST],
			[PH_NO],
			[PHYSICIAN2],
			[PH_SPEC2],
			[PH_ADDR2],
			[PH_ADDR22],
			[PH_CITY2],
			[PH_STATE2],
			[PH_PHONE2],
			[PH_PHONEX2],
			[PH_FAX2],
			[PH_ZIP2],
			[PH_UPIN2],
			[PH_MCD2],
			[PH_DEA2],
			[PH_LIC2],
			[PH_LAST2],
			[PH_FIRST2],
			[PH_NO2],
			[ROUTE],
			[MED_HIST],
			[DELIVINS],
			[PUMP],
			[PUMPTYPE],
			[PUMP_SSN],
			[ACCESS],
			[PLACED],
			[WHOPLACED],
			[PUMPPARAMS],
			[ORDERS],
			[LABORDERS],
			[DIET],
			[ACTLEVEL],
			[HOSPITAL],
			[HOSP_ROOM],
			[ADM_DATE],
			[REF_DATE],
			[HEIGHT],
			[WEIGHT],
			[ALLERGIES],
			[CULTSENS],
			[SOC],
			[CODESTAT],
			[ADVDIRECT],
			[DISC_DATE],
			[DIAGNOSIS1],
			[DIAGNOSIS2],
			[DIAGNOSIS3],
			[ADD_DIAG],
			[ICD91],
			[ICD92],
			[ICD93],
			[ICD94],
			[SURGERY1],
			[SURGDATE1],
			[SURGERY2],
			[SURGDATE2],
			[DIABETIC],
			[REFERRAL],
			[SALESREP],
			[SALESCODE],
			[NURSE_AGEN],
			[NURSE_CONT],
			[NURSE_PHON],
			[NURSE_FAX],
			[NURSE_ADDR],
			[NURSE_CITY],
			[NURSE_ST],
			[NURSE_ZIP],
			[PRIMARY_RN],
			[CM],
			[CONTACT],
			[CONT_PHONE],
			[CONT_REL],
			[PCG],
			[PCG_PHONE],
			[PCG_REL],
			[SERVAREA],
			[MARITAL],
			[ACCIDENT],
			[PHARMACY],
			[PHARMPHONE],
			[PHARM1],
			[PHARM2],
			[PHARM3],
			[DIRECTIONS],
			[PAT_TYPE],
			[PAT_STAT],
			[ONHOLDSTAR],
			[ONHOLDSTOP],
			[BP],
			[HR],
			[RR],
			[TEMP],
			[P_DLSEEN],
			[PCPLASTREV],
			[BALANCE],
			[LASTBILLED],
			[LASTPAYREC],
			[BILL_STAT],
			[STATORDER],
			[NUMTODO],
			[USERDEF1],
			[USERDEF2],
			[USERDEF3],
			[USERDEF4],
			[USERDEF5],
			[USERDEF6],
			[USERDEF7],
			[NOCATH],
			[LICNUM],
			[SITENO],
			[ALERT_B],
			[ALERT_C],
			[PAT_CAT],
			[USEHHLA],
			[SENTHHLA],
			[HEIGHTCM],
			[WEIGHTKG],
			[BSA],
			[LBW],
			[LBWKG],
			[IBW],
			[IBWKG],
			[OTHALLERGY],
			[SHOWDCD],
			[WT],
			[NREV_PCP],
			[NREV_MDCP],
			[NREV_NCP],
			[PFUNC],
			[PTO],
			[MAX_FAX_NO],
			[DEFCOLLECT],
			[DEMOCOMPL],
			[PHONEEVE],
			[PH_CONT],
			[PH_CONT2],
			[WEIGHTDATE],
			[INUSE],
			[LASTFAX],
			[UPDATED],
			[DELFLAG],
			[TOUCHDATE],
			[CHGBYHOST],
			[CREATEDON],
			[CREATEDBY],
			[RELPROTINFO],
			[WORKPHONE],
			[CELLPHONE],
			[AGENCYFK],
			[SALESFK],
			[SHP_INCLUDEINOUTCOMES],
			[SHP_SITEOFSERVICE],
			[SHP_SITEOFSERVICEOTHER],
			[SHP_ACUITYADMISSION],
			[SHP_CATHETERTRACKING],
			[PCG_PHONE2],
			[CONT_PHONE2],
			[SHP_WEIGHTADMITNUMBER],
			[MAILNAME],
			[SHP_STATUS],
			[PH_ORG],
			[PH_ORG2],
			[MCDNUM],
			[CONVKEY],
			[COLLECTOR],
			[CPK_HR],
			[EMAIL],
			[CFK_PNNAMES_RESPONSIBLE],
			[CFK_REFSOURC],
			[CFK_POPUPDATA_ENTTEAMS],
			[PSEXCLUDE],
			[PSMESSAGE],
			[WEBACCESS],
			[CBA],
			[LOCKED],
			[SENDDTEMAIL],
			[LICENSEISSUER],
			[LICENSEQUALIFIER],
			[CFK_TAXCODES],
			[PAT_BAL],
			[PSSEPARATE],
			[CFK_INSCOMP_CONTRACT],
			[ASSISTMED],
			[MSDUPLOAD],
			[ISTHERIGYPATIENT],
			[isalertbpopulated],
			[isalertcpopulated],
			[latitude],
			[longitude],
			[primaryph],
			[licstate],
			[labelalert],
			[poinjrxalerts],
			[healthcaredatainteroppatientkey],
           @DateTime AS [EffectiveDate],
           NULL AS [ExpirationDate],
           1 AS [CurrentRowFlag],
           0 AS [DeleteRowFlag],
           @DateTime AS [InsertDate]
    FROM [stage].[CPR_HR] AS [s]
    WHERE NOT EXISTS
    (
        SELECT *
        FROM [ods].[CPR_HR] AS [t]
        WHERE [t].[MRN] = [s].[MRN]
              AND [t].[CurrentRowFlag] = 1
    );

END;
